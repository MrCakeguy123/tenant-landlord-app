{% extends "base.html" %}
{% block content %}
  <section class="card">
    <h1>{{ t('hello') }}, {{ user.full_name or user.username }}</h1>
    <p class="subtitle">{{ t('tenant_dashboard_title') }}</p>

    {% if lease %}
      <h2>{{ t('tenant_rent_for_month') }} {{ rent_month_label }}</h2>
      <p>
        {{ t('tenant_monthly_rent') }}:
        <strong>${{ '%.2f'|format(lease.monthly_rent or 0) }}</strong>
        (due on day {{ lease.due_day }} each month)
      </p>
      <p>
        {{ t('tenant_this_month_paid') }}:
        <strong>${{ '%.2f'|format(rent_paid or 0) }}</strong>
        /
        <strong>${{ '%.2f'|format(lease.monthly_rent or 0) }}</strong>
      </p>
      <p>
        {{ t('tenant_status') }}:
        {% set rent_class =
          'paid' if rent_status == 'Paid'
          else ('partial' if rent_status == 'Partial'
          else 'unpaid')
        %}
        <span class="status-badge status-{{ rent_class }}">
          {{ rent_status }}
        </span>
      </p>

      <h3>{{ t('tenant_record_payment') }}</h3>
      <form method="post" action="{{ url_for('tenant_pay_rent') }}" class="form">
        <label>
          Amount
          <input type="number" step="0.01" name="amount" required>
        </label>
        <label>
          Method
          <select name="method">
            <option value="Cash">Cash</option>
            <option value="Check">Check</option>
            <option value="Zelle">Zelle</option>
            <option value="Venmo">Venmo</option>
            <option value="Bank transfer">Bank transfer</option>
            <option value="Other">Other</option>
          </select>
        </label>
        <label>
          Note (optional)
          <textarea name="note" rows="2"></textarea>
        </label>
        <button class="button primary" type="submit">Record payment</button>
      </form>

      <h3>{{ t('tenant_pay_online_heading') }}</h3>
      <form method="post" action="{{ url_for('tenant_stripe_checkout') }}" class="form">
        <p>
          You will be redirected to a secure payment page to pay the remaining balance for this month.
        </p>
        <button class="button primary" type="submit">{{ t('tenant_pay_online_button') }}</button>
      </form>

      <h3>Recent rent payments</h3>
      {% if recent_payments %}
        <table class="table">
          <thead>
            <tr>
              <th>Paid at</th>
              <th>Amount</th>
              <th>Month</th>
              <th>Year</th>
              <th>Method</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            {% for p in recent_payments %}
              <tr>
                <td>{{ p.paid_at }}</td>
                <td>${{ '%.2f'|format(p.amount or 0) }}</td>
                <td>{{ p.month }}</td>
                <td>{{ p.year }}</td>
                <td>{{ p.method or 'N/A' }}</td>
                <td>{{ p.note or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>No rent payments recorded yet.</p>
      {% endif %}
    {% else %}
      <p>You do not have an active lease. Please contact your landlord.</p>
    {% endif %}
  </section>

  <section class="card">
    <h2>Maintenance requests</h2>
    <p><a class="button primary" href="{{ url_for('new_request') }}">Submit a new request</a></p>
    {% if requests %}
      <table class="table">
        <thead>
          <tr>
            <th>{{ t('col_created') }}</th>
            <th>{{ t('col_title') }}</th>
            <th>{{ t('col_description') }}</th>
            <th>Image</th>
            <th>{{ t('col_priority') }}</th>
            <th>{{ t('col_status') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in requests %}
            {% set priority = r.priority or 'Normal' %}
            {% set p_key = 'priority_' + priority|lower %}
            {% set p_class = 'priority-' + priority|lower %}
            <tr class="{% if r.is_overdue %}row-overdue{% endif %}">
              <td>{{ r.created_at }}</td>
              <td>{{ r.title }}</td>
              <td>{{ r.description }}</td>
              <td>
                {% if r.image_filename %}
                  <a href="{{ r.image_filename }}" target="_blank" rel="noopener">View</a>
                  <div class="thumbnail-wrapper">
                    <img src="{{ r.image_filename }}" alt="Request image" class="thumbnail">
                  </div>
                {% else %}
                  <span class="muted-text">No image</span>
                {% endif %}
              </td>
              <td>
                <span class="priority-badge {{ p_class }}">
                  {{ t(p_key) }}
                </span>
              </td>
              <td>
                {% if r.status == 'Open' %}
                  {% set m_class = 'open' %}
                {% elif r.status == 'In progress' %}
                  {% set m_class = 'in-progress' %}
                {% else %}
                  {% set m_class = 'completed' %}
                {% endif %}
                <span class="status-badge status-{{ m_class }}">
                  {{ r.status }}
                </span>
                {% if r.is_overdue %}
                  <span class="overdue-badge">{{ t('label_overdue') }}</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>You have no maintenance requests yet.</p>
    {% endif %}
  </section>
{% endblock %}
