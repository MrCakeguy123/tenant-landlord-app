{% extends "base.html" %}
{% block content %}
  {% if announcements %}
  <section class="card announcement-card">
    <h2>ðŸ“¢ {{ t('announcements_title') }}</h2>
    {% for a in announcements %}
      <div class="announcement">
        <h3>{{ a.title }}</h3>
        <p>{{ a.content }}</p>
        <small class="muted-text">{{ t('announcements_posted') }}: {{ a.created_at[:10] if a.created_at else 'N/A' }}</small>
      </div>
      {% if not loop.last %}<hr>{% endif %}
    {% endfor %}
  </section>
  {% endif %}

  <section class="card">
    <h1>{{ t('hello') }}, {{ user.full_name or user.username }}</h1>
    <p class="subtitle">{{ t('tenant_dashboard_title') }}</p>

    {% if lease %}
      <h2>{{ t('tenant_rent_for_month') }} {{ rent_month_label }}</h2>
      <p>
        {{ t('tenant_monthly_rent') }}:
        <strong>${{ '%.2f'|format(lease.monthly_rent or 0) }}</strong>
        ({{ t('rent_due_on_day') }} {{ lease.due_day }} {{ t('rent_each_month') }})
      </p>
      <p>
        {{ t('tenant_this_month_paid') }}:
        <strong>${{ '%.2f'|format(rent_paid or 0) }}</strong>
        /
        <strong>${{ '%.2f'|format(lease.monthly_rent or 0) }}</strong>
      </p>
      <p>
        {{ t('tenant_status') }}:
        {% set rent_class =
          'paid' if rent_status == 'Paid'
          else ('partial' if rent_status == 'Partial'
          else 'unpaid')
        %}
        <span class="status-badge status-{{ rent_class }}">
          {% if rent_status == 'Paid' %}{{ t('status_paid') }}{% elif rent_status == 'Partial' %}{{ t('status_partial') }}{% else %}{{ t('status_unpaid') }}{% endif %}
        </span>
      </p>

      <h3>{{ t('tenant_record_payment') }}</h3>
      <form method="post" action="{{ url_for('tenant_pay_rent') }}" class="form">
        <label>
          {{ t('rent_amount') }}
          <input type="number" step="0.01" name="amount" required>
        </label>
        <label>
          {{ t('rent_method') }}
          <select name="method">
            <option value="Cash">{{ t('rent_cash') }}</option>
            <option value="Check">{{ t('rent_check') }}</option>
            <option value="Zelle">Zelle</option>
            <option value="Venmo">Venmo</option>
            <option value="Bank transfer">{{ t('rent_bank_transfer') }}</option>
            <option value="Other">{{ t('rent_other') }}</option>
          </select>
        </label>
        <label>
          {{ t('rent_note_optional') }}
          <textarea name="note" rows="2"></textarea>
        </label>
        <button class="button primary" type="submit">{{ t('rent_record_payment') }}</button>
      </form>

      <h3>{{ t('tenant_pay_online_heading') }}</h3>
      <form method="post" action="{{ url_for('tenant_stripe_checkout') }}" class="form">
        <p>
          {{ t('rent_stripe_redirect') }}
        </p>
        <button class="button primary" type="submit">{{ t('tenant_pay_online_button') }}</button>
      </form>

      <h3>{{ t('rent_recent_payments') }}</h3>
      {% if recent_payments %}
        <table class="table">
          <thead>
            <tr>
              <th>{{ t('rent_paid_at') }}</th>
              <th>{{ t('rent_amount') }}</th>
              <th>{{ t('rent_month') }}</th>
              <th>{{ t('rent_year') }}</th>
              <th>{{ t('rent_method') }}</th>
              <th>{{ t('rent_note') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for p in recent_payments %}
              <tr>
                <td>{{ p.paid_at }}</td>
                <td>${{ '%.2f'|format(p.amount or 0) }}</td>
                <td>{{ p.month }}</td>
                <td>{{ p.year }}</td>
                <td>{{ p.method or 'N/A' }}</td>
                <td>{{ p.note or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>{{ t('rent_no_payments') }}</p>
      {% endif %}
    {% else %}
      <p>{{ t('rent_no_lease') }}</p>
    {% endif %}
  </section>

  <section class="card">
    <h2>{{ t('maintenance_requests') }}</h2>
    <p><a class="button primary" href="{{ url_for('new_request') }}">{{ t('maintenance_submit_new') }}</a></p>
    {% if requests %}
      <table class="table">
        <thead>
          <tr>
            <th>{{ t('col_created') }}</th>
            <th>{{ t('col_title') }}</th>
            <th>{{ t('col_description') }}</th>
            <th>{{ t('maintenance_image') }}</th>
            <th>{{ t('col_priority') }}</th>
            <th>{{ t('col_status') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in requests %}
            {% set priority = r.priority or 'Normal' %}
            {% set p_key = 'priority_' + priority|lower %}
            {% set p_class = 'priority-' + priority|lower %}
            <tr class="{% if r.is_overdue %}row-overdue{% endif %}">
              <td>{{ r.created_at }}</td>
              <td>{{ r.title }}</td>
              <td>{{ r.description }}</td>
              <td>
                {% if r.image_filename %}
                  <a href="{{ r.image_filename }}" target="_blank" rel="noopener">{{ t('maintenance_view') }}</a>
                  <div class="thumbnail-wrapper">
                    <img src="{{ r.image_filename }}" alt="Request image" class="thumbnail">
                  </div>
                {% else %}
                  <span class="muted-text">{{ t('maintenance_no_image') }}</span>
                {% endif %}
              </td>
              <td>
                <span class="priority-badge {{ p_class }}">
                  {{ t(p_key) }}
                </span>
              </td>
              <td>
                {% if r.status == 'Open' %}
                  {% set m_class = 'open' %}
                {% elif r.status == 'In progress' %}
                  {% set m_class = 'in-progress' %}
                {% else %}
                  {% set m_class = 'completed' %}
                {% endif %}
                <span class="status-badge status-{{ m_class }}">
                  {% if r.status == 'Open' %}{{ t('status_open') }}{% elif r.status == 'In progress' %}{{ t('status_in_progress') }}{% else %}{{ t('status_completed') }}{% endif %}
                </span>
                {% if r.is_overdue %}
                  <span class="overdue-badge">{{ t('label_overdue') }}</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>{{ t('maintenance_none') }}</p>
    {% endif %}
  </section>
{% endblock %}
